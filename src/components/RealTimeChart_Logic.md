# RealTimeChart 模块逻辑说明

`RealTimeChart` 是一个用于可视化实时物理数据的组件，位于 `src/components/RealTimeChart.js`。它使用 **Canvas 2D API** 进行绘制，并采用 **环形缓冲区 (Ring Buffer)** 来高效存储和渲染数据流。

## 1. 数据存储 (Ring Buffer)

为了避免 JavaScript 数组频繁 `push/shift` 操作带来的性能开销（会导致大量的内存分配和垃圾回收），组件内部维护了一个固定大小的数组。

- **结构**：
  - `this.buffer`: 固定长度的数组（默认容量 3600，即 60FPS 下的 60秒数据）。
  - `this.head`: 指针，指向下一个数据插入的位置。
  - `this.count`: 当前缓冲区内的有效数据数量。
- **写入逻辑**：
  新数据总是写入 `this.head` 指向的索引位置。写入后，`head` 指针加 1。如果 `head` 超过数组长度，则回绕到 0（模运算）。
- **读取逻辑**：
  读取时，通过公式 `(head - count + i + capacity) % capacity` 计算真实索引，从而按时间顺序（从旧到新）遍历数据。

## 2. X 轴逻辑 (时间窗口)

X 轴代表仿真时间 `t`。显示范围由 `this.windowSec` (默认 30s) 控制，支持动态调整。

- **滚动机制**：
  - **静态阶段** (`t < windowSec`)：X 轴范围固定为 `[0, windowSec]`。曲线从左向右延伸，直到填满屏幕。
  - **滚动阶段** (`t > windowSec`)：X 轴随时间向左滚动。
    - 最右侧（屏幕右边缘）：当前最新时间 `newestT`。
    - 最左侧（屏幕左边缘）：`newestT - windowSec`。
- **坐标映射**：
  ```javascript
  // 将时间 t 映射到 Canvas 的 x 坐标
  x = width - (newestT - t) * (width / windowSec);
  ```
  这确保了最新的数据点总是在画布的最右侧（或当前进度的位置）。

## 3. Y 轴逻辑 (自动缩放)

Y 轴代表物理量（如位置、速度、加速度）。原点 `0` 始终固定在画布的垂直中心。

- **自动量程 (Auto-scaling)**：
  组件维护一个历史最大绝对值 `maxAbs`。每次添加新数据 (`push`) 时，更新此值：`maxAbs = Math.max(maxAbs, Math.abs(newValue))`。
  - **注意**：此值只增不减（直到调用 `clear()` 重置）。这确保了在阻尼振动等场景下，Y 轴比例保持稳定，用户可以直观地看到振幅的衰减，而不是看到波形始终充满屏幕。
- **动态比例**：
  - 为了防止曲线顶到画布边缘，设置了 20% 的余量：`yMax = maxAbs * 1.2`。
  - 初始默认 `maxAbs = 0.1`。
- **坐标映射**：
  ```javascript
  // 将数值 value 映射到 Canvas 的 y 坐标
  // height / 2 是画布中心
  // 负号是因为 Canvas Y 轴向下为正，而物理坐标系通常向上为正
  y = height / 2 - (value / yMax) * (height * 0.45);
  ```

## 4. 刻度与网格

- **背景网格**：
  `drawGrid` 方法绘制固定的背景网格（每 50px 一条垂直线，每 25px 一条水平线）。网格是静态的视觉参考，**不随数据滚动**。
- **零线**：
  在 `height / 2` 处绘制一条白色虚线，清晰标记 `0` 值位置。
- **标签与刻度**：
  - 左上角：图表标题（如 "Velocity"）。
  - 右下角：X 轴单位 `t (s)`。
  - 左侧零线旁：标记 `0`。
  - **X 轴刻度**：底部每隔 5 秒绘制一个时间刻度，随时间轴滚动。

## 5. 画图流程 (`draw` 方法)

每一帧（或每次调用 `push` 添加数据时）都会触发重绘：

1.  **清空画布**：使用 `clearRect` 清除上一帧内容。
2.  **空数据检查**：
    - 检查 `this.seriesNames` 是否为空。
    - 如果为空，在画布中心绘制“不涉及曲线”提示文字，并直接返回，不再绘制后续内容。
3.  **绘制静态元素**：绘制网格、坐标轴线、文字标签和图例。
4.  **计算比例**：
    - 计算当前数据的 Y 轴最大值 `yMax`。
    - 确定当前最新的时间戳 `newestT`。
5.  **绘制曲线**：
    - 遍历 `colors` 数组（支持在一个图表中绘制多条曲线）。
    - 对每条曲线，遍历环形缓冲区中的点。
    - **过滤**：跳过时间窗口之外（`t < newestT - windowSec`）的旧数据。
    - **连线**：使用 `moveTo` 和 `lineTo` 连接各点。
    - **描边**：调用 `stroke()` 上色。
