# GIF 录制功能实现指南

## 1. 目标
允许用户直接从物理模拟中生成轻量级的 GIF 动画缩略图。这些 GIF 将用作应用程序首页的动态预览。

## 2. 技术栈
- **库**: `gif.js` (客户端 JavaScript GIF 编码器)
- **渲染**: HTML5 Canvas API
- **并发**: Web Workers 用于非阻塞编码

## 3. 实现过程

### 第一阶段：初步集成
- **方法**: 通过 CDN 添加 `gif.js`。
- **问题**: 遇到 `SecurityError` (CORS)，因为 Web Workers 无法加载来自不同源的脚本。
- **解决方案**: 将 `gif.js` 和 `gif.worker.js` 下载到本地 `public/` 目录，以便从同源提供服务。

### 第二阶段：录制逻辑
- **机制**: 
  1. 重置模拟到 `t=0`。
  2. 启动定时器循环。
  3. 将主画布内容绘制到临时画布上。
  4. 将帧添加到 GIF 编码器。
- **挑战**: 文件体积过大（10秒 15 FPS 约为 10MB）。
- **优化**: 
  - 将录制帧率降低至 **0.5 FPS**（每2秒1帧）。
  - 将播放速度提高 **5倍**。
  - 结果：10秒的模拟被压缩为5帧、2秒的循环动画。

### 第三阶段：质量与伪影处理
- **问题 1: 锯齿 (Aliasing)**: 将画布缩小 50% 导致严重的锯齿边缘。
  - **修复**: 移除缩放（保持 1:1 分辨率），依靠低帧率来控制文件大小。
- **问题 2: 鬼影 (Ghosting)**: 上一帧的内容在当前帧下可见（残影）。
  - **修复**: 
    1. 在每次绘制前显式地用黑色 (`#000000`) 填充临时画布。
    2. 将 GIF 帧处理方法 (disposal method) 设置为 `2` (恢复为背景色)。

### 第四阶段：UI/UX 改进
- **反馈**: 用户需要了解录制状态。
- **实现**: 
  - 将“录制”按钮转换为进度条。
  - **录制阶段**: 随着帧的捕获，红色进度条从 0% 填充到 100%。
  - **编码阶段**: 随着 Web Worker 处理 GIF，进度条重置并重新填充。
  - **完成**: 按钮重置为初始状态，文件自动下载。

## 4. 代码结构 (`ControlPanel.js`)

```javascript
async recordGif(duration, btn) {
    // 1. 设置与 UI 锁定
    // 2. 重置模拟 & 强制初始渲染
    // 3. 配置 GIF 编码器 (Quality: 1, Workers: 2)
    
    // 4. 捕获循环 (setInterval)
    const capture = () => {
        // 清除画布 (修复鬼影)
        // 绘制帧
        // 添加到 GIF
        // 更新 UI 进度
    };

    // 5. 编码与下载
    gif.on('finished', (blob) => {
        // 触发下载
        // 重置 UI
    });
}
```

## 5. 使用流程
1. 导航到一个场景（例如：波的干涉）。
2. 点击 **"录制 GIF (10s)"**。
3. 等待按钮进度条完成（录制中 -> 编码中）。
4. 将下载的 `scene-animation.gif` 重命名为目标名称（例如 `wave-interference.gif`）。
5. 将文件移动到 `public/` 文件夹。
